---

name: CI | Test

on:
  push:
    branches: [ '**' ]
#    paths:
#      - 'scripts/**'
  pull_request:
    branches: [ main ]
#    paths:
#      - 'scripts/**'

env:
  DEVNET_PATH: private-testnet
  DEVNET_READY_FLAG: ready.flag

jobs:
  test:
    runs-on: ubuntu-20.04
    timeout-minutes: 5 # this should not take longer thant that (for now)

    container:
      image: ghcr.io/grzegorznowak/cardano-node:1.33.0
    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: '0'

      - name: Acceptance Test
        run: |-
          export PATH="/root/bin:${PATH}"
          nohup scripts/automate.sh &
          while [ ! -f ${DEVNET_PATH}/${DEVNET_READY_FLAG} ]; do sleep 5; done
          CARDANO_NODE_SOCKET_PATH=/root/cardano_devnet/private-testnet/node-bft1/node.sock
          /root/bin/cardano-cli query utxo --whole-utxo --testnet-magic 42
